<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <title>Structured Data Readiness</title>
</head>
<body>
    {% include 'universalComponents.html'%}
    s
    <h1 style="text-align:center; margin-bottom:1%;">Structured Data Readiness</h1>
    <div style="width: 100%; display: block;">
        <p style="
          margin: 0 auto;
          padding-bottom:3%;
          text-align: center;
          font-size: 1.25rem;
          line-height: 1.4;
          white-space: normal;
          word-break: break-word;
          overflow-wrap: break-word;
          display: block;
        ">
          Upload a supported structured dataset to evaluate it on the metrics available below
    </p>
    </div>
    <form id="uploadForm" method="post" enctype="multipart/form-data" style="display: flex; flex-direction: row; ">
        <div style="display: flex; width: 35%; flex-direction:column;">
            <select id="fileTypeSelector" name="fileTypeSelector" class="fileType" style="margin:0; border-radius: 10px 10px 0 0; padding: 15px; width:100%; max-width:none; text-align:center; font-size:1.5em;">
                <option disabled value="" {% if not file_type%}selected{% endif %}>Select a File Type</option>
                {% for ext, label in supported_file_types %}
                    <option value="{{ ext }}" {% if file_type == ext %}selected{% endif %}>
                        {{ label }} ({{ ext }})
                    </option>
                {% endfor %}
                <!-- 
                Add additional supported file types here using the following template:
                    <option value="new_file_type"{%if file_type=='new_file_type'%}selected{%endif%}>File Type Name (new_file_type)</option>
                -->

            </select>



            <label id="fileUploadContainer" for="file" class="custum-file-upload" required>
                <div class="icon">
                <!--Credit for the image-->
                {% if uploaded_file_path %}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#212121"><path d="M240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>
                {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"  fill="#212121"><path d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/></svg>
                {% endif %}
                </div>

                <input id="file" name="file" type="file"  required onchange="uploadForm(); positionPreview();">
                <br>
                <div id="fileLabel" style="color:#ffffff">
                    {% if uploaded_file_path %}
                    <script>
                        fileUploadContainer = document.getElementById("fileUploadContainer");
                        fileUploadContainer.style.borderRadius = "0px 0px 0px 0px";
                        fileUploadContainer.style.border = "2px  #e8e8e8 solid";
                        fileUploadContainer.style.borderBottom = "none";
                    </script>
                    <h2 id="FileUploadMessage">File Uploaded: {{uploaded_file_name}}</h2>
                    {% else %}
                    <h2 id="FileUploadMessage" style="transition: all 0.3s;">Please Upload a File</h2>
                    {% endif %}
                </div>
                
            </label>
            {% if uploaded_file_path %}
                <!-- clear button: visible when file is uploaded, change form style to match-->
                <button type="button" class="clear-button" onclick="clearFile()">Clear Uploaded File</button>
            {% endif %}
            <!-- Progress bar for upload status -->
            <div id="fileUploadProgress" class = "progress-bar-container" style = "position:relative; bottom:10px; padding-top:10px; height:44.5px;">
                <div id="progressBar" style="align-self:center; text-align:center; width:80%;">
                    <progress id="progress" style="width:100%; height:30px;" value=0 max=100></progress>
                </div>
            </div>
            <script>
                {% if uploaded_file_path %}
                    progressBar = document.getElementById("fileUploadProgress");
                    progressBar.classList.remove("visible");
                {% endif %}
            </script>
        </div>
        <div style="display: flex; flex-direction: column; margin-top: 10px; align-self: center; width: max-content;">
        {% if uploaded_file_path %}
            <h3 onclick="togglePillarDropdown('dataQualityDropdown')">Data Quality<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="dataQualityDropdown">
                    <strong id="toggleButton_quality" class="toggle-button clickable" onclick="location.href='{{url_for("dataQuality")}}'"> Data Quality Metrics<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 onclick="togglePillarDropdown('AIImpactDropdown')">Impact of Data on AI<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="AIImpactDropdown">
                    <strong id="toggleButton_featureRelevance" class="toggle-button clickable" onclick="location.href='{{url_for("featureRelevance")}}'"> Feature Relevance<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                    <strong id="toggleButton_correlation" class="toggle-button clickable" onclick="location.href='{{url_for("correlationAnalysis")}}'"> Correlation Analysis<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 onclick="togglePillarDropdown('FairnessDropdown')">Fairness and Bias<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="FairnessDropdown">
                    <strong id="toggleButton_fairness" class="toggle-button clickable" onclick="location.href='{{url_for("fairness")}}'"> Fairness Metrics<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                    <strong id="toggleButton_classImbalance" class="toggle-button clickable" onclick="location.href='{{url_for("classImbalance")}}'"> Class Imbalance<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 onclick="togglePillarDropdown('DataGovernanceDropdown')">Data Governance<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="DataGovernanceDropdown">
                    <strong id="toggleButton_privacy" class="toggle-button clickable" onclick="location.href='{{url_for("privacyPreservation")}}'"> Privacy Preservation<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 onclick="togglePillarDropdown('UnderstandabilityDropdown')">Understandability and Usability<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="UnderstandabilityDropdown">
                    <strong id="toggleButton_FAIR" class="toggle-button clickable" onclick="location.href='{{url_for("FAIR")}}'"> FAIR Compliance Evaluation<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 onclick="togglePillarDropdown('DataStructureDropdown')">Data Structure and Organization<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="DataStructureDropdown">
                    <strong class="toggle-button">No metrics available for this pillar yet</strong>
                </div>

        {% else %}
            <h3 class="noUpload metric-info">Data Quality<span class="metric-info-text">Please upload a file</span></h3>
                <div id="dataQualityDropdown">
                    <strong id="toggleButton_quality" class="toggle-button metric-info"> Data Quality Metrics<span class="metric-info-text">Please upload a file</span></strong>
                </div>
            <h3 class="noUpload metric-info">Impact of Data on AI<span class="metric-info-text">Please upload a file</span></h3>
                <div id="AIImpactDropdown">
                    <strong id="toggleButton_featureRelevance" class="toggle-button metric-info"> Feature Relevance<span class="metric-info-text">Please upload a file</span></strong>
                    <strong id="toggleButton_correlation" class="toggle-button metric-info"> Correlation Analysis<span class="metric-info-text">Please upload a file</span></strong>
                </div>
            <h3 class="noUpload metric-info">Fairness and Bias<span class="metric-info-text">Please upload a file</span></h3>
                <div id="FairnessDropdown">
                    <strong id="toggleButton_fairness" class="toggle-button metric-info"> Fairness Metrics<span class="metric-info-text">Please upload a file</span></strong>
                    <strong id="toggleButton_classImbalance" class="toggle-button metric-info"> Class Imbalance<span class="metric-info-text">Please upload a file</span></strong>
                </div>
            <h3 class="noUpload metric-info">Data Governance<span class="metric-info-text">Please upload a file</span></h3>
                <div id="DataGovernanceDropdown">
                    <strong id="toggleButton_privacy" class="toggle-button metric-info"> Privacy Preservation<span class="metric-info-text">Please upload a file</span></strong>
                </div>
            <h3 onclick="togglePillarDropdown('UnderstandabilityDropdown')">Understandability and Usability<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></h3>
                <div id="UnderstandabilityDropdown">
                    <strong id="toggleButton_FAIR" class="toggle-button clickable" onclick="location.href='{{url_for("FAIR")}}'"> FAIR Compliance Evaluation<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M400-280v-400l200 200-200 200Z"/></svg></strong>
                </div>
            <h3 class="noUpload metric-info">Data Structure and Organization<span class="metric-info-text">Please upload a file</span></h3>
        {% endif %}
        </div>
    </form>
    <!-- Filled with detected keys when Hierarchical data is detected -->
    <form id="filePreview" class="preview" {% if not file_preview %}style="display:none"{% endif %}  enctype="multipart/form-data">
        <h3 style="margin-left:0px; display:block; text-align:center; margin-bottom:0px;">Hierarchical Data Detected</h1>    
        <p>The following keys were detected. Select the keys you wish to parse.<p>
            <table id="file_preview"></table>  
            <button class="animated-button" style="display:flex; align-self:center; justify-content:center;" type="submit" onclick="modifyFile();">
                    <span>Save</span>
                    <span></span>
            </button>
        <script>
            const preview = {{ file_preview | tojson | safe }};
            
            const currently_checked = {{ current_checked_keys | tojson | safe }}
            {% if session.get('minimize_preview') %}
                document.getElementById("filePreview").classList.add("minimized");
            {% endif %}
            window.renderPreview = function() {
                return {
                    preview: preview,
                    checked: currently_checked,
                };
            };
        </script>
    </form>



    <button id="SelectionEdit" type="button" class="edit-button" onclick="editSelections()">Edit Selections</button>
    <strong onclick="location.href='{{url_for("publications")}}'" class="clickable" style="text-align: center; font-size: 1.5em; display:flex; align-items:center; align-self:center">Publications  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm188-212-56-56 372-372H560v-80h280v280h-80v-144L388-332Z"/></svg></strong>
    
</body>
<script>
    //for uploads
    function uploadForm() {
        document.getElementById("fileUploadProgress").classList.add("visible");
        document.getElementById('uploadForm').dispatchEvent(new Event('submit', { cancelable: true }));
    }
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent normal form submission

        
        uploadMessage = document.getElementById("FileUploadMessage");
        uploadMessage.innerHTML = "File Uploading...";

        const form = document.getElementById('uploadForm');
        const formData = new FormData(form);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for("upload_file") }}', true);  

        xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                document.getElementById("progress").value = percent;
                console.log(`Upload progress: ${percent}%`);
            }
        };
        xhr.onload = function () {
            if (xhr.status === 200) {
                window.location.href = '{{ url_for("upload_file") }}'; //Send GET
            } else {
                uploadMessage.innerHTML = "Upload failed.";
            }
        };
        xhr.send(formData);
    });
    //get file type from user
    document.addEventListener("DOMContentLoaded", function () {
        //file type selector and file input field
        const fileTypeElement = document.getElementById("fileTypeSelector");
        const fileInput = document.getElementById("file");
        const fileUploadMessage = document.getElementById("FileUploadMessage");
        const fileTypeSelector = document.getElementById("fileTypeSelector");
        // Bind select to function
        fileTypeElement.addEventListener("change", function () {
            updateFileInputBasedOnType(fileTypeElement, fileInput, fileUploadMessage);
        });
        // Call it once on page load 
        updateFileInputBasedOnType(fileTypeElement, fileInput,fileUploadMessage);

        if (window.renderPreview) {
            const { preview, checked } = window.renderPreview();

            // Get table element by ID
            const table = $('#file_preview');
            table.empty();
            // Add Select All
            const selectAllRow = $('<tr>');
            const selectAllCheckbox = $('<input>').attr({
                type: 'checkbox',
                id: 'selectAllCheckbox',
                style: 'margin-right:10px',
                onchange: 'toggleSelectAll(this)'
            });
            const selectAllLabel = $('<label>')
                .attr('style', 'display: flex; flex-direction: row; min-width: 125px; align-items: center;margin-left:10px;')
                .addClass('material-checkbox')
                .append(selectAllCheckbox)
                .append($('<span>').addClass('checkmark'))
                .append('Select All');

            const selectAllCell = $('<td style="border-bottom:0px;">').append(selectAllLabel);
            selectAllRow.append(selectAllCell);
            table.append(selectAllRow);
            for (let i = 0; i < preview.length; i++) {
                const row = $('<tr>');
                table.append(row);

                const checkbox = $('<input>').attr({
                    type: 'checkbox',
                    class: 'checkbox individual',
                    style: 'margin-right:10px',
                    onchange: 'toggleValueIndividual(this)',
                    name: 'checkboxValues',
                    id: preview[i] + 'checkbox_' + i,
                    value: preview[i],
                });

                const span = $('<span>').addClass('checkmark');

                const label = $('<label>')
                    .attr('style', 'display: flex; flex-direction: row; min-width: 125px; align-items: center;margin-left:30px;')
                    .attr('class', 'material-checkbox')
                    .attr('id', preview[i] + 'checkbox_' + i);

                label.append(checkbox).append(span).append(preview[i]);
                const cell = $('<td style="border-bottom:0px;">').append(label);
                row.append(cell);
            }
            const checkboxes = document.querySelectorAll('.checkbox.individual');
            if(checked){
                checkboxes.forEach(cb => {
                    const label = cb.closest("label");
                    const text = label.textContent.trim();
                    
                    if (checked.includes(text)) {
                        cb.checked = true;
                        cb.value = text;
                    } else {
                        cb.checked = false;
                        cb.value = "no";
                    }

                    console.log("Checkbox value:", cb.value); // For debugging
                });
                updateSelectAllState();
            }
        }
    });
    //select all functionality
    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('.checkbox.individual');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
            if (cb.checked) {
                const label = cb.closest("label");
                const text = label.textContent.trim();
                cb.value = text;
            } else {
                cb.value = "no";
            }
            console.log("Checkbox value:", cb.value); // For debugging 
        });
    }

    function modifyFile(){
        var form = document.getElementById('filePreview');
        var formData = new FormData(form);
        var checkboxValues = Array.from(formData.getAll('checkboxValues')).join(',');
        console.log("Checkbox Values:",checkboxValues);
        

        fetch('/filter_file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keys: checkboxValues })  // Send as JSON list
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                
                window.location.href = '/upload_file?minimize_preview=true';  // Now reload to get preview data
            } else {
                openErrorPopup('Filtering Error', data.error || 'Unknown error');
            }
        })
        .catch(error => {
            openErrorPopup('Network Error', error);
        });
    }
    // Set hierarchical file selection tab relative to upload_form
    function positionPreview() {
        const uploadContainer = document.getElementById("fileUploadContainer");
        const filePreview = document.getElementById("filePreview");
        const editSelections = document.getElementById("SelectionEdit");

        const uploadFormRect = uploadContainer.getBoundingClientRect();
        filePreview.style.position = 'absolute';
    
        
        filePreview.style.width = `${uploadFormRect.width}px`;
        filePreview.style.height = `${uploadFormRect.height}px`;
        filePreview.style.left = `${uploadFormRect.left + window.scrollX}px`;
        filePreview.style.top = `${uploadFormRect.top + window.scrollY}px`;
        if(filePreview.classList.contains('minimized')){
            const height = 40.5;
            const top = uploadFormRect.top + uploadFormRect.height - height + window.scrollY;
            const left = uploadFormRect.left + window.scrollX;
            filePreview.style.top = `${top}px`;
            filePreview.style.height = `${height}px`;

            editSelections.style.top = `${top}px`;
            editSelections.style.left = `${left}px`;
            editSelections.style.width = `${uploadFormRect.width}px`;
            editSelections.style.height = `${height}px`;
            editSelections.style.display = 'flex';
        


        }
        
        filePreview.style.opacity='1';
    };
    function editSelections(){
        const filePreview = document.getElementById("filePreview");
        const editSelections = document.getElementById("SelectionEdit");
        filePreview.classList.remove("minimized");
        editSelections.style.display = 'none';
        positionPreview();
    }
    document.addEventListener("DOMContentLoaded",function(){
        positionPreview();
    });
    window.addEventListener('scroll', positionPreview);
    window.addEventListener('resize', positionPreview);
    window.addEventListener('click',positionPreview)

</script>
</html>