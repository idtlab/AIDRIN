<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <title>Structured Data Readiness</title>

    <style>
        body {
        font-family: Arial, sans-serif;
        margin: 20px;
        }

        h1 {
            color: #333;
        }

        #fileInput {
            margin-bottom: 20px;
        }

        #summaryStatistics {
            margin-top: 20px;
            
        }

        #summaryStatistics h3{
            text-align: center;            
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #Statresult {
            margin-bottom: 10px;
        }

        strong {
            color: #333;
        }

        span {
            color: #666;
        }

        .plot-container {
            margin-top: 20px;
            text-align: center;
        }

        img {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <h1>Structured Data Readiness</h1>
    <form id="uploadForm" method="post" enctype="multipart/form-data">
        <label for="file">Choose a CSV file:</label>
        <input type="file" name = 'file' id="file" accept=".csv" required>

        <div id="summaryStatistics"></div>
        <div class="plot-container" id="histogramsContainer"></div>

        <h3>Select analysis options:</h3>

        <input type="checkbox" name="completeness" value="yes"> Check completeness<br>
        <input type="checkbox" name="outliers" value="yes"> Check outliers<br>
        <input type="checkbox" name="duplicity" value="yes"> Check duplicity<br>
        <input type="checkbox" name="representation rate" value="yes"> Check representation rate<br>
        
        <label for="features for representation rate">Sensitive feature to measure representation rate:</label>
        <select name="features for representation rate" required>
            <option value="" disabled selected>Select a feature</option>
            <!-- Options will be added dynamically using JavaScript -->
        </select><br>

        <input type="checkbox" name="statistical rate" value="yes"> Check statistical rate<br>
        <label for="features for statistical rate">Features for statistical rate:</label>
        <input type="text" name="features for statistical rate">
        <label for="target for statitical rate">Target for statistical rate:</label>
        <input type="text" name="target for statitical rate"><br>

        <input type="checkbox" name="real representation rate" value="yes"> Check real representation rate<br>
        
        <label for="real column">Real Column:</label>
        <select name="real column" required>
            <option value="" disabled selected>Select a feature</option>
            <!-- Options will be added dynamically using JavaScript -->
        </select><br>
        
        <label for="real attributes">Real attributes:</label>
        <input type="text" name="real attributes">
        <label for="real values">Real values:</label>
        <input type="text" name="real values"><br>

        <input type="checkbox" name="compare real to dataset" value="yes"> Compare real world to dataset representation rates<br>

        <input type="checkbox" name="correlations" value="yes"> Perform Correlation Analysis<br>
        <label for="correlationColumns">Choose the columns for correlation analysis:</label>
        <!-- Checkboxes for correlations -->
        <div id="checkboxContainer"></div>
        <br>

        <input type="checkbox" name="top 3 features" value="yes"> Check top 3 features<br>
        <label for="categorical features for feature relevancy">Categorical features to measure top 3 features:</label>
        <input type="text" name="categorical features for feature relevancy">
        <label for="numerical features for feature relevancy">Numerical features to measure top 3 features:</label>
        <input type="text" name="numerical features for feature relevancy">
        <label for="target for feature relevance">Target feature to measure top 3 features:</label>
        <input type="text" name="target for feature relevance"><br>

        <input type="checkbox" name="privacy preservation" value="yes"> Check privacy preservation<br>
        <label for="numerical features to add noise">Numerical features to add noise:</label>
        <input type="text" name="numerical features to add noise">

        <label for="privacy budget">Privacy budget (epsilon):</label>
        <input type="text" name="privacy budget"><br>

        <button type="button" onclick="submitForm()">Submit</button>
        
        <!-- Reset button with event listener -->
        <input type="reset" value="Reset" id="resetButton">

        <div id="buttonsContainer" style="display:none;">
            <button type="button" id="visualizationBtn" onclick="showVisualization()">Show Visualization</button>
            <button type="button" id="jsonBtn" onclick="showJSON()">Show JSON</button>
            <button type="button" id="jsonBtn" onclick="downloadJSON()">Download JSON</button>
            

        </div>
    </form>

    
    <div id="resultContainer" style="display:none;"></div>
    

    <script>

        //generate summary statistics
        $(document).ready(function () {
            $('#file').on('change', function () {
                var fileInput = document.getElementById('file');
                var file = fileInput.files[0];
                

                var formData = new FormData();
                formData.append('file', file);
               
                $.ajax({
                    url: '/summary_statistics',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        if (response.success) {
                            
                            $('#recordsCount').text(response.records_count);
                            $('#catFeatures').text(response.categorical_features);
                            $('#numFeatures').text(response.numerical_features);
                           

                            // Display additional summary statistics
                            
                            var statisticsHTML = '<p id="Statresult"><strong>Number of Features:</strong> <span id="featuresCount">' + response.features_count + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Number of Data Points:</strong> <span id="recordsCount">' + response.records_count + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Categorical Features:</strong> <span id="catFeatures">' + response.categorical_features + '</span></p>';
                            statisticsHTML += '<p id="Statresult"><strong>Numerical Features:</strong> <span id="numFeatures">' + response.numerical_features + '</span></p><br>';
                            statisticsHTML += '<h3>Summary Statistics Table</h3><table>';
                            statisticsHTML += '<tr><th><strong>Statistic</strong></th>'; // Bold header for the "Statistic" column

                            // Iterate over the keys to create columns (excluding the first key)
                            for (var key in response.summary_statistics) {
                                statisticsHTML += '<th>' + key + '</th>';
                            }
                            statisticsHTML += '</tr>'; // End of the header row

                            // Iterate over the statistics for each key
                            for (var statKey in response.summary_statistics[key]) {
                                statisticsHTML += '<tr><td><strong>' + statKey + '</strong></td>'; // Bold row for the "Feature" column

                                // Iterate over the keys to get values for each column
                                for (var key in response.summary_statistics) {
                                    var statValue = response.summary_statistics[key][statKey];

                                    statisticsHTML += '<td>' + statValue + '</td>';
                                }
                                statisticsHTML += '</tr>'; // End of the row
                            }

                            statisticsHTML += '</table>';
                            $('#summaryStatistics').html(statisticsHTML);

                            // Display histograms
                            var histogramsContainer = $('#histogramsContainer');
                            histogramsContainer.empty();
                            histogramsContainer.append('<br><h3>Summary Statistic Plots</h3>'); // Add heading for histograms

                            for (var feature in response.histograms) {
                                var base64Image = response.histograms[feature];
                                var img = document.createElement('img');
                                img.src = 'data:image/png;base64,' + base64Image;
                                img.alt = feature + ' Histogram';
                                histogramsContainer.append(img);
                            }
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            });
        });

        //generate dropdown when features of the dataset are required to select
        $(document).ready(function() {
            $('input[type="file"]').change(function(e) {
                var fileInput = $(this);
                var file = fileInput.prop('files')[0];

                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var content = e.target.result;
                        var lines = content.split('\n');
                        if (lines.length > 0) {
                            var columns = lines[0].split(',');
                            displayColumns(columns);
                        }
                    };
                    reader.readAsText(file);
                }
            });

            var columnsLoaded = {
                'features for representation rate': false,
                'real column': false
            };

            var checkboxesLoaded = false;

            function displayColumns(columns) {
                for (var dropdownName in columnsLoaded) {
                    var selectedColumnDropdown = $('select[name="' + dropdownName + '"]');

                    if (!columnsLoaded[dropdownName]) {
                        // Adding the default option only if columns haven't been loaded yet
                        selectedColumnDropdown.append($('<option value="" disabled>Select a ' + dropdownName + '</option>'));
                        columnsLoaded[dropdownName] = true;
                    }

                    selectedColumnDropdown.empty();

                    if (columns.length > 0) {
                        columns.forEach(function(column) {
                            selectedColumnDropdown.append($('<option>').text(column));
                        });
                    } else {
                        selectedColumnDropdown.append($('<option>').text('No columns found in the CSV file.').attr('disabled', 'disabled'));
                    }
                }

                // Checkboxes
                if (!checkboxesLoaded) {
                    var checkboxContainer = $('#checkboxContainer');
                    var table = $('<table>').appendTo(checkboxContainer);
                    var row, cell;

                    for (var i = 0; i < columns.length; i++) {
                        if (i % 4 === 0) {
                            // Start a new row for every 4 columns
                            row = $('<tr>').appendTo(table);
                        }

                        cell = $('<td>').appendTo(row);
                        var checkbox = $('<input type="checkbox" class="columnCheckbox">')
                            .attr('id', 'checkbox_' + columns[i])
                            .attr('value', columns[i])
                            .attr('name', 'checkboxValues');

                        var label = $('<label>')
                            .attr('for', 'checkbox_' + columns[i])
                            .text(columns[i]);

                        cell.append(checkbox);
                        cell.append(label);
                    }

                    checkboxesLoaded = true;
                }
            }
        });

        document.getElementById('resetButton').addEventListener('click', function() {
            // Reload the page when the reset button is clicked
            location.reload();
        });
        
        function submitForm() {
            var form = document.getElementById('uploadForm');
            var formData = new FormData(form);

            // Get the values of the checkboxes and concatenate them with a comma
            var checkboxValues = Array.from(formData.getAll('checkboxValues')).join(',');

            // Add the concatenated checkbox values to the form data
            formData.set('correlation columns', checkboxValues);

            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            fetch('/upload_file', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                var resultContainer = document.getElementById('resultContainer');

                resp_data = data;

                // Function to check if a key is present and not undefined
                function isKeyPresentAndDefined(obj, key) {
                    return obj && obj[key] !== undefined;
                }

                // Check if "Completeness Visualization" key is present
                if (isKeyPresentAndDefined(data, 'Completeness') && isKeyPresentAndDefined(data['Completeness'], 'Completeness Visualization')) {
                    // Display the chart image
                    resultContainer.innerHTML += '<img id="complVis" style="display:none;" src="data:image/png;base64,' + data['Completeness']['Completeness Visualization'] + '" alt="Completeness Chart">';
                }

                // Check if "Outliers Visualization" key is present
                if (isKeyPresentAndDefined(data, 'Outliers') && isKeyPresentAndDefined(data['Outliers'], 'Outliers Visualization')) {
                    // Display the chart image
                    resultContainer.innerHTML += '<img id="outVis" style="display:none;" src="data:image/png;base64,' + data['Outliers']['Outliers Visualization'] + '" alt="Outliers Chart">';
                }

                if (
                    isKeyPresentAndDefined(data, 'Representation Rate') &&
                    isKeyPresentAndDefined(data['Representation Rate'], 'Representation Rate Chart')
                ) {
                    // Display the chart image
                    resultContainer.innerHTML += '<img id="repVis" style="display:none;" src="data:image/png;base64,' + data['Representation Rate']['Representation Rate Chart']+ '" alt="Representation Rate Chart">';
                }

                // Check if "Representation Rate Comparison with Real World" key and "Comparisons" key are present
                if (
                    isKeyPresentAndDefined(data, 'Representation Rate Comparison with Real World') &&
                    isKeyPresentAndDefined(data['Representation Rate Comparison with Real World']['Comparisons'], 'Comparison Visualization')
                ) {
                    // Display the chart image
                    resultContainer.innerHTML += '<img id="compVis" style="display:none;" src="data:image/png;base64,' + data['Representation Rate Comparison with Real World']['Comparisons']['Comparison Visualization'] + '" alt="Comparisons Chart">';
                }

                if (isKeyPresentAndDefined(data, 'Correlations Analysis') && isKeyPresentAndDefined(data['Correlations Analysis'], 'Correlation Matrix')) {
                    // Display the correlations chart image
                    resultContainer.innerHTML += '<img id="corrVis" style="display:none;" src="data:image/png;base64,' + data['Correlations Analysis']['Correlation Matrix'] + '" alt="Correlation Matrix">';
                }

                if (isKeyPresentAndDefined(data, 'Privacy preservation statistics') && isKeyPresentAndDefined(data['Privacy preservation statistics'], 'Combined Plots')) {
                    // Display the noisy vs normal feature chart image
                    resultContainer.innerHTML += '<img id="noisyVis" style="display:none;" src="data:image/png;base64,' + data['Privacy preservation statistics']['Combined Plots'] + '" alt="Normal vs Noisy Feature Box Plots">';
          
                }

                //Display other result information as JSON
                resultContainer.innerHTML += '<pre id="jsonResult" style="display:none;">' + JSON.stringify(data, null, 2) + '</pre>';
                
                // Show the result container after the response is generated
                resultContainer.style.display = 'block';

                // Show the buttons after the response is generated
                document.getElementById('buttonsContainer').style.display = 'block';

                
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

    function showVisualization() {
        // Show Completeness Visualization content if it exists
        var completenessContent = document.getElementById('complVis');
        if (completenessContent) {
            completenessContent.style.display = 'block';
        }

        // Show Outliers Visualization content if it exists
        var outliersContent = document.getElementById('outVis');
        if (outliersContent) {
            outliersContent.style.display = 'block';
        }

        // Show Representation Rate Visualization content if it exists
        var representationRateContent = document.getElementById('repVis');
        if (representationRateContent) {
            representationRateContent.style.display = 'block';
        }

        // Show Comparison Visualization content if it exists
        var comparisonContent = document.getElementById('compVis');
        if (comparisonContent) {
            comparisonContent.style.display = 'block';
        }

        // Show Correlation Visualization content if it exists
        var corrContent = document.getElementById('corrVis');
        if (corrContent) {
            corrContent.style.display = 'block';
        }

        // Show Normal vs Noisy Feature Visualization content if it exists
        var corrContent = document.getElementById('noisyVis');
        if (corrContent) {
            corrContent.style.display = 'block';
        }

        // ... (Add similar logic for other visualizations)

        // Hide JSON content
        var jsonResultContainer = document.getElementById('jsonResult');
        if (jsonResultContainer) {
            jsonResultContainer.style.display = 'none';
        }
    }

    function downloadJSON() {
        // Get the JSON data
        var jsonData = JSON.stringify(resp_data, null, 2);

        // Create a Blob with the JSON data
        var blob = new Blob([jsonData], { type: 'application/json' });

        // Create a link element
        var link = document.createElement('a');

        // Set the link's href attribute to a data URL containing the Blob
        link.href = window.URL.createObjectURL(blob);

        // Set the link's download attribute to specify the file name
        link.download = 'result.json';

        // Append the link to the document
        document.body.appendChild(link);

        // Trigger a click on the link to start the download
        link.click();

        // Remove the link from the document
        document.body.removeChild(link);
    }

    function showJSON() {
        // Show Completeness Visualization content if it exists
        var jsonResult = document.getElementById('jsonResult');
        if (jsonResult) {
            jsonResult.style.display = 'block';
        }
    }
</script>

</body>
</html>
